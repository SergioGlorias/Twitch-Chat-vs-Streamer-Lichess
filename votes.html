<!DOCTYPE html>
<html>
  <head>
    <title>Votes</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

      body {
        background: #161512 linear-gradient(to bottom, #2e2a24, #161512 116px) no-repeat;
        background: transparent;
        margin: 0px;
        overflow: hidden;
        color: white;
        font-size: 2rem;
        font-family: 'Roboto', sans-serif;
      }

      #text {
        position: fixed;
        top: 0;
        left: 0;
        margin: 0px;
      }

      ul {
        padding: 0;
        margin: 0;
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body>
    <div id="outline"></div>
    <div id="text"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const streamer = urlParams.get('streamer');

      const socket = io();

      const appendMove = (text) => {
        const ul = document.createElement('ul');
        ul.appendChild(document.createTextNode(text));
        window.text.appendChild(ul);
      };

      if (streamer) {
        setInterval(() => socket.emit('streamer', streamer), 2000); // interval so it can reconnect in case the bot goes down temporarily
        appendMove('Waiting for game ...');
        appendMove('Example:');
        appendMove('Ke2 42 votes');
        appendMove('e4: 15 votes');
        appendMove('Nf3 2 votes');
      } else {
        appendMove("You need to specify a streamer by appending '?streamer=twitch username' to the URL.");
      }

      socket.on('candidates', (candidates) => {
        if (!candidates.total) return;
        window.text.innerHTML = "";
        if ('draw' in candidates)
          appendMove(`Offer/accept draw: ${Math.floor((candidates.draw.votes / candidates.total) * 100)}%`);
        const sortedCandidates = Object.entries(candidates)
          .filter(([k, _]) => k !== 'total' && k !== 'draw')
          .sort(([_, a], [__, b]) => b.votes - a.votes);
        for (const [key, candidate] of sortedCandidates) {
          const { votes, san } = candidate;
          const text = `${san ? san : key}: ${votes} vote${votes === 1 ? '' : 's'}`;
          appendMove(text);
        }
      });
    </script>
  </body>
</html>
